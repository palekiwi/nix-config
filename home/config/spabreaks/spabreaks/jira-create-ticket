#!/usr/bin/env nu

# Simple JIRA ticket creator for Spabreaks project
# Usage: ./jira-create-ticket "Ticket Title" "Ticket Description"

# Check if required environment variables are set
let required_vars = ["JIRA_URL", "JIRA_EMAIL", "JIRA_TOKEN", "JIRA_PROJECT"]
let missing_vars = ($required_vars | where ($env | get -i $in | is-empty))

if ($missing_vars | length) > 0 {
    print $"Error: Missing environment variables: ($missing_vars | str join ', ')"
    print "Please ensure these are set in your .envrc file"
    exit 1
}

# Validate command line arguments
if ($argv | length) < 2 {
    print "Usage: ./jira-create-simple.nu \"Ticket Title\" \"Ticket Description\""
    exit 1
}

let title = $argv.0
let description = $argv.1

# Build JIRA API payload
let payload = {
    fields: {
        project: { key: $env.JIRA_PROJECT }
        summary: $title
        description: $description
        issuetype: { name: "Task" }
    }
}

# Convert payload to JSON
let json_payload = ($payload | to json)

# Create basic auth header
let auth_header = $"Basic ([$env.JIRA_EMAIL, $env.JIRA_TOKEN] | str join ':' | base64)"

print "Creating JIRA ticket..."

try {
    let response = (http post 
        $"($env.JIRA_URL)/rest/api/3/issue"
        $json_payload
        --headers [
            Authorization: $auth_header
            Content-Type: "application/json"
        ]
    )
    
    let ticket_key = $response.key
    let ticket_url = $"($env.JIRA_URL)/browse/($ticket_key)"
    
    print "Ticket created successfully!"
    print $"Ticket: ($ticket_key)"
    print $"URL: ($ticket_url)"
    
} catch { |err|
    print $"Error creating ticket: ($err.msg)"
    exit 1
}